<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>New Tab</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2032%2032'%3E%3Ctext%20x='0'%20y='28'%20font-size='32'%3EðŸ’Ž%3C/text%3E%3C/svg%3E">

    <link rel="preload" as="image" href="/background.jpg" type="image/jpeg">

    <style>
        html {
            background-color: #1E1E1E;
        }

        * {
            margin: 0;
            padding: 0;
            border: none;
            background: none;
            outline: none;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        #background {
            background-image: url("/background.jpg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            min-height: 100vh;
            width: 100%;
            padding: 0 16px;
        }

        #app {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            padding: 24px 0;
            min-height: 100vh;
            max-width: 640px;
        }


        
        #time {
            position: absolute;
            top: calc(50% - 54px / 2 - 144px);
            left: 50%;
            transform: translate(-50%, -50%);
            color: #E2E8F0;
            font-size: 120px;
            font-weight: 600;
            user-select: none;
            cursor: default;
        }



        #widget-list {
            position: absolute;
            top: calc(50% - 54px / 2 - 60px);
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: row;
            gap: 24px;
            height: 28px;
            color: #E2E8F0;
        }
        #widget-list:focus-visible {
            outline: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            outline-offset: 8px;
        }

        .widget {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
        }
        .widget-icon {
            height: 100%;
            aspect-ratio: 1/1;
        }
        .widget-value {
            font-weight: 400;
            font-size: 20px;
            user-select: none;
            cursor: default;
        }



        #engine {
            width: 100%;
            height: 54px;
            position: relative;
        }

        #search-bar {
            display: flex;
            flex-direction: row;
            align-items: center;
            border-radius: 16px;
            color: #E2E8F0;
            background-color: rgba(255, 255, 255, 0.1);
            width: 100%;
            height: 100%;
            overflow: hidden;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px); 
        }

        #search-icon-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            aspect-ratio: 1/1;
            align-self: flex-start;
            flex-shrink: 0;
        }
        #search-icon {
            width: 28px;
            height: 28px;
        }

        #search-input {
            color: inherit;
            font-size: 24px;
            flex-grow: 1;
            padding: 0 4px;
        }
        #search-input::placeholder {
            color: inherit;
        }

        #search-submit-btn {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            aspect-ratio: 1/1;
            align-self: flex-end;
            flex-shrink: 0;
            color: inherit;
            transition: all 0.3s ease;
        }
        #search-submit-btn:hover, #search-submit-btn:focus {
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.05);
        }
        #search-submit-icon {
            width: 26px;
            height: 26px;
        }
    </style>


    <script defer>
        document.addEventListener("DOMContentLoaded", () => {
            // clock
            const hour = document.getElementById("hour");
            const minute = document.getElementById("minute");
            const renderTime = () => {
                const now = new Date()
                hour.textContent = String(now.getHours()).padStart(2, '0');
                minute.textContent = String(now.getMinutes()).padStart(2, '0');
            }
            
            const initClock = () => {
                renderTime();

                const now = new Date();
                const msUntilNextMinute = (60 - now.getSeconds()) * 1000 - now.getMilliseconds();
                setTimeout(() => {
                    renderTime();
                    setInterval(renderTime, 60000);
                }, msUntilNextMinute);
            }

            initClock();


            // weather display
            const fetchWeatherData = async () => {
                try {
                    const latitude = localStorage.getItem("latitude");
                    const longitude = localStorage.getItem("longitude");

                    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&hourly=temperature_2m,precipitation_probability,weather_code,is_day&timezone=auto&forecast_days=1`);
                    if (!response.ok) throw new Error("Network error. Try again later.");

                    const weatherData = await response.json();
                    localStorage.setItem("forecastUntil", weatherData.hourly.time.at(-1));
                    localStorage.setItem("forecastData", JSON.stringify(weatherData));
                } 
                catch (error) {
                    alert(`Error fetching weather data: ${error.message}`);
                }
            }

            const renderWeatherData = () => {
                const weatherData = JSON.parse(localStorage.getItem("forecastData"));

                const now = new Date(new Date().setMinutes(0, 0, 0));
                const start = new Date(weatherData.hourly.time[0]);
                const hourIndex = Math.min(Math.floor((now - start) / 3600000), weatherData.hourly.time.length - 1);

                const weatherCode = Number(weatherData.hourly.weather_code[hourIndex]);
                const isDay = Boolean(weatherData.hourly.is_day[hourIndex]);

                let weatherIcon;
                switch (weatherCode) {
                    case 0:
                        weatherIcon = isDay ? 'sun' : 'moon';
                        break;
                    
                    case 1: case 2: case 3: case 45: case 48: 
                        weatherIcon = 'cloudy';
                        break; 
                    
                    case 51: case 53: case 55: case 56: case 57: case 61: case 63: case 65: case 66: case 67: case 80: case 81: case 82:
                        weatherIcon = 'rain';
                        break;
                    
                    case 71: case 73: case 75: case 77: case 85: case 86:
                        weatherIcon = 'snow';
                        break;
                    
                    case 95: case 96: case 99:
                        weatherIcon = "thunder";
                        break;

                    default:
                        weatherIcon = "sun";
                }

                const weatherIconContainer = document.getElementById('weather-icon');
                const clone = document.getElementById(`icon-${weatherIcon}`).content.cloneNode(true);
                weatherIconContainer.firstElementChild.replaceWith(clone);

                const temperature = document.getElementById('temperature');
                temperature.textContent = `${Math.floor(Number(weatherData.hourly.temperature_2m[hourIndex]))}Â°C`;

                const precipitationChance = document.getElementById('precipitation-chance');
                precipitationChance.textContent = `${weatherData.hourly.precipitation_probability[hourIndex]}%`;
            }

            const initWeather = async () => {
                if (!localStorage.getItem('latitude') || !localStorage.getItem('longitude')) 
                    return;
                
                const nowFloored = new Date(new Date().setMinutes(0, 0, 0));
                if (!localStorage.getItem('forecastUntil') || !localStorage.getItem('forecastData') ||
                    nowFloored > new Date(localStorage.getItem('forecastUntil'))
                )
                    // renders previous forecast last value if expired to prevent placeholder brief flash
                    if (localStorage.getItem('forecastData')) renderWeatherData();

                    await fetchWeatherData();
                
                renderWeatherData();

                const now = new Date();
                const msUntilNextHour = (60 - now.getMinutes()) * 60000 - now.getSeconds() * 1000 - now.getMilliseconds() + 50; // slight buffer
                setTimeout(initWeather, msUntilNextHour);
            };

            const setWeatherButton = document.getElementById("widget-list");
            setWeatherButton.addEventListener("click", () => {
                const input = prompt("Enter your location's latitude and longitude separated by comma. \n(latitude, longitude): ")
                if (!input) return;

                const [latitude, longitude] = input.split(",").map(val => Number(val.trim()));
                if (isNaN(latitude) || isNaN(longitude) || latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180) {
                    alert("Invalid coordinates. \nLatitude must be -90 to 90, longitude -180 to 180. \nPlease enter something like: 37.44, -122.34");
                    return;
                }

                localStorage.setItem("latitude", latitude.toString());
                localStorage.setItem("longitude", longitude.toString());

                initWeather();
            });

            initWeather();
        });
    </script>
</head>

<body id="background">
    <!-- Weather icons templates -->
    <template id="icon-sun"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></template>
    <template id="icon-moon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></template>
    <template id="icon-cloudy"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg></template>
    <template id="icon-rain"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="16" y1="13" x2="16" y2="21"></line><line x1="8" y1="13" x2="8" y2="21"></line><line x1="12" y1="15" x2="12" y2="23"></line><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></svg></template>
    <template id="icon-thunder"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"></path><polyline points="13 11 9 17 15 17 11 23"></polyline></svg></template>
    <template id="icon-snow"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16a.5.5 0 0 1-.5-.5v-1.293l-.646.647a.5.5 0 0 1-.707-.708L7.5 12.793V8.866l-3.4 1.963-.496 1.85a.5.5 0 1 1-.966-.26l.237-.882-1.12.646a.5.5 0 0 1-.5-.866l1.12-.646-.884-.237a.5.5 0 1 1 .26-.966l1.848.495L7 8 3.6 6.037l-1.85.495a.5.5 0 0 1-.258-.966l.883-.237-1.12-.646a.5.5 0 1 1 .5-.866l1.12.646-.237-.883a.5.5 0 1 1 .966-.258l.495 1.849L7.5 7.134V3.207L6.147 1.854a.5.5 0 1 1 .707-.708l.646.647V.5a.5.5 0 1 1 1 0v1.293l.647-.647a.5.5 0 1 1 .707.708L8.5 3.207v3.927l3.4-1.963.496-1.85a.5.5 0 1 1 .966.26l-.236.882 1.12-.646a.5.5 0 0 1 .5.866l-1.12.646.883.237a.5.5 0 1 1-.26.966l-1.848-.495L9 8l3.4 1.963 1.849-.495a.5.5 0 0 1 .259.966l-.883.237 1.12.646a.5.5 0 0 1-.5.866l-1.12-.646.236.883a.5.5 0 1 1-.966.258l-.495-1.849-3.4-1.963v3.927l1.353 1.353a.5.5 0 0 1-.707.708l-.647-.647V15.5a.5.5 0 0 1-.5.5z"/></svg></template>


    <main id="app">
        <h1 id="time">
            <span id="hour">00</span>:<span id="minute">00</span>
        </h1>

        <button id="widget-list">
            <div class="widget">
                <div id="weather-icon" class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </div>

                <p id="temperature" class="widget-value">
                    N/A
                </p>
            </div>

            <div class="widget">
                <div id="precipitation-icon" class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 12a11.05 11.05 0 0 0-22 0zm-5 7a3 3 0 0 1-6 0v-7"></path>
                    </svg>
                </div>
                
                <p id="precipitation-chance" class="widget-value">
                    Click to activate
                </p>
            </div>
        </button>

        <div id="engine">
            <!-- TODO -->
            <form id="search-bar">
                <div id="search-icon-container">
                    <svg id="search-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-width="2.4" d="m21 21-3.5-3.5M17 10a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z"/>
                    </svg>
                </div>

                <input type="text" id="search-input" name="search-input" placeholder="Search" autofocus autocomplete="off">

                <button type="submit" id="search-submit-btn">
                    <svg id="search-submit-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
                    </svg>
                </button>
            </form>
            
            <!-- TODO -->
            <section id="suggestion">
            </section>

            <!-- TODO -->
            <section id="pin">
            </section>
        </div>
    </main>
</body>
</html>